var SignUpPreferredLocationComponent=function(n,t,i,r,u,f,e){function o(t){var r=this,u;r.element=t;r.$element=n(r.element);r.locationsListProcessor=null;r.$searchBtn=r.$element.find("[data-ref=search]");u=r.$element.find("[data-ref=locations-list-template]");u.length>0&&(r.locationsListProcessor=i.compile(u.html()));r.init()}return o.prototype.init=function(){var t=this,i={},r;n.extend(!0,i,n.validator.custom.settings);r={submitHandler:function(i){var r=n(i).find("input[name=searchTerm]").val();r&&(t.$searchBtn.addClass("loading"),t.searchLocations(r,null,null,t.$searchBtn))}};n.extend(!0,i,r);t.$element.find("[data-ref=form]").validate(i);t.$element.find("[data-ref=search-by-coords]").on("click",function(i){var r,u;i.preventDefault();r=n(this);r.addClass("loading");u=e.getPositionFromGeolocation();u.done(function(n){var i=n.latitude.toString(),u=n.longitude.toString();t.searchLocations(null,i,u,r)}).fail(function(n){r.removeClass("loading");n===null||n===undefined?window.alert("could not find your location"):n.code===1?window.alert("you must allow the device to use location services"):window.alert("could not find your location")})})},o.prototype.searchLocations=function(t,i,r,u){var o=this,e=o.$element.data("search-url"),s=!1;if(t?(t=t.replace(/<.*?>/g,""),e+="?locationname="+encodeURI(t)):i&&r&&(e+="?lat="+i+"&lng="+r,s=!0),!s&&!t){u&&u.length&&u.removeClass("loading");return}f.getCall(e,function(i){i||(i={});u&&u.length&&u.removeClass("loading");!i.Locations||!i.Locations.length||(i.Locations=i.Locations.filter(function(n){return!!n&&!!n.StoreNumber}));n.extend(!0,i,{SearchTerm:t,HasLocations:!!i.Locations&&!!i.Locations.length});o.renderSearchLocationsResult(i)})},o.prototype.renderSearchLocationsResult=function(n){var t=this,i;t.$element.find(".modal-note").addClass("hidden");t.$element.find("[data-ref=save]").removeClass("hidden").addClass("disabled").data("ofl-step-data","");i=t.locationsListProcessor(n);t.$element.find("[data-ref=results]").removeClass("hidden").html(i);t.initMoreLess();t.initSelectLocation()},o.prototype.initMoreLess=function(){var n=this},o.prototype.initSelectLocation=function(){var i=this;i.$element.find("[data-ref=selectlocation]").on("click",function(t){t.preventDefault();i.$element.find(".cpt-location-result").removeClass("active");var r=n(this).data("ofl-step-data");r&&(n(this).closest(".cpt-location-result").addClass("active"),i.$element.find("[data-ref=save]").data("ofl-step-data",r).removeClass("disabled"))});i.$element.find("[data-ref=save]").off("click").on("click",function(r){var e,o,s;(r.preventDefault(),e=n(this),e.hasClass("disabled"))||(o=e.data("ofl-step-data"),s=i.$element.attr("data-select-favorite-url"),o)&&(e.addClass("loading"),f.postBackgroundCall(s,{restaurantId:o}).done(function(n){if(!n||!n.RestaurantId){e.removeClass("loading");return}f.getCall(i.$element.attr("data-next-step-url"),function(n){var i=t.GetOrAddComponent(u);i.OnClose(function(){document.location.href="/"});i.Open(e,n)})}).fail(function(){e.removeClass("loading");console.log("Error when trying to set favorite location")}))})},t.RegisterAutoCreateComponent({selector:"SignUpPreferredLocationComponent",type:o}),o}(jQuery,ComponentsFactory,Handlebars,UtilityNavComponent,ModalDialogFull,ServerCall,BrowserGeoPositionDetector)